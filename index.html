<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycb.../exec"; // <-- Twój link
  let codes = [];

  function updateList() {
    const list = document.getElementById("codeList");
    list.innerHTML = "";
    codes.forEach((code, index) => {
      const li = document.createElement("li");
      li.innerHTML = `${code} <span class="remove-btn" onclick="removeCode(${index})">✕</span>`;
      list.appendChild(li);
    });
  }

  function removeCode(index) {
    codes.splice(index, 1);
    updateList();
  }

  function addManual() {
    const input = document.getElementById("manualInput").value.trim();
    if (input && !codes.includes(input)) {
      codes.push(input);
      document.getElementById("manualInput").value = "";
      updateList();
    }
  }

  // ✅ Właściwa funkcja wysyłania danych:
  function sendAll() {
    if (!confirm("Czy na pewno chcesz wysłać dane do arkusza?")) return;

    const trasa = document.getElementById("trasa").value.trim();
    const nrRejestracyjny = document.getElementById("nrRejestracyjny").value.trim();
    const dostawa = document.getElementById("dostawa").value.trim();
    const info = document.getElementById("info").value.trim();
    const moduly = document.getElementById("moduly").value.trim();

    if (!trasa || !nrRejestracyjny || !dostawa || !moduly || codes.length === 0) {
      alert("Uzupełnij wszystkie wymagane pola i dodaj przynajmniej jeden kod.");
      return;
    }

    const formData = new FormData();
    formData.append("trasa", trasa);
    formData.append("nrRejestracyjny", nrRejestracyjny);
    formData.append("dostawa", dostawa);
    formData.append("info", info);
    formData.append("moduly", moduly);
    formData.append("codes", JSON.stringify(codes));

    fetch(scriptURL, {
      method: 'POST',
      body: formData
    })
    .then(res => res.text())
    .then(txt => {
      document.getElementById("status").innerText = "✅ Dane wysłane";
      codes = [];
      updateList();

      document.getElementById("trasa").value = "";
      document.getElementById("nrRejestracyjny").value = "";
      document.getElementById("dostawa").value = "";
      document.getElementById("info").value = "";
      document.getElementById("moduly").value = "";

      setTimeout(() => {
        document.getElementById("status").innerText = "";
      }, 3000);
    })
    .catch(err => {
      document.getElementById("status").innerText = "❌ Błąd: " + err;
    });
  }

  // ✅ Skaner QR
  const qrScanner = new Html5Qrcode("reader");
  qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (text) => {
      if (!codes.includes(text)) {
        codes.push(text);
        updateList();
        qrScanner.pause();
        setTimeout(() => qrScanner.resume(), 1000);
      }
    }
  );
</script>
